// Generated by CoffeeScript 1.7.1
(function() {
  var GREEN_HSL, GREEN_HUE, RED_HUE, add_heatmap, css_property_to_color, get_color, get_meta_tag_contents, metric, records, report,
    __hasProp = {}.hasOwnProperty,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  String.prototype.trunc = function(n) {
    var _ref;
    return this.substr(0, n - 1) + ((_ref = this.length > n) != null ? _ref : {
      '&hellip;': ''
    });
  };

  report = {
    sample: {
      name: '',
      phenotype: '',
      bam: '',
      bed: '',
      vcf_by_caller: {
        name: '',
        summary_qc_rep_fpaths: [],
        anno_vcf_fpaths: {},
        anno_filt_vcf_fpaths: {}
      }
    },
    fpath: '',
    link: '',
    records: []
  };

  records = {
    metric: null,
    value: '',
    meta: null
  };

  metric = {
    name: '',
    short_name: '',
    description: '',
    quality: '',
    presision: 0,
    type: null
  };

  get_meta_tag_contents = function(rec) {
    var db, dbs, k, meta, meta_table, novelty, val, values, _i, _len;
    metric = rec.metric;
    meta = rec.meta;
    if ((meta != null) && meta.length !== 0) {
      return "class=\"meta_info_span tooltip-meta\" rel=\"tooltip\"";
      if (typeof meta === 'string') {
        return "class=\"meta_info_span tooltip-meta\" rel=\"tooltip\" title=\"" + meta + "\"";
      } else {
        ((function() {
          var _results;
          _results = [];
          for (k in meta) {
            if (!__hasProp.call(meta, k)) continue;
            _results.push(k);
          }
          return _results;
        })()).length !== 0;
        meta_table = '<table class=\'qc_meta_table\'>\n<tr><td></td>';
        for (novelty in meta) {
          values = meta[novelty];
          if (novelty !== 'all') {
            meta_table += "<td>" + novelty + "</td>";
          }
        }
        meta_table += '</tr>\n';
        for (novelty in meta) {
          values = meta[novelty];
          dbs = (function() {
            var _results;
            _results = [];
            for (db in values) {
              val = values[db];
              if (db !== 'average') {
                _results.push(db);
              }
            }
            return _results;
          })();
          dbs.push('average');
          break;
        }
        for (_i = 0, _len = dbs.length; _i < _len; _i++) {
          db = dbs[_i];
          meta_table += "<tr><td>" + db + "</td>";
          for (novelty in meta) {
            values = meta[novelty];
            if (novelty !== 'all') {
              meta_table += "<td>" + (toPrettyString(values[db], metric.unit)) + "</td>";
            }
          }
          meta_table += '</tr>\n';
        }
        meta_table += '</table>\n';
        return "class=\"meta_info_span tooltip-meta\" rel=\"tooltip\" title=\"" + meta_table + "\"";
      }
    }
  };

  RED_HUE = 0;

  GREEN_HUE = 120;

  GREEN_HSL = 'hsl(' + GREEN_HUE + ', 80%, 40%)';

  reporting.buildTotalReport = function(report, columnOrder, date) {
    var hue, legend, lightness, metric_html, pos, rec, recNum, result, sampleLink, sampleName, sampleReport, step, table, value, _i, _j, _k, _l, _len, _ref, _ref1;
    $('#report_date').html('<p>' + date + '</p>');
    table = "<table cellspacing=\"0\" class=\"report_table draggable fix-align-char\" id=\"main_report_table\">";
    table += "\n<tr class=\"top_row_tr\">";
    table += "<td id=\"top_left_td\" class=\"left_column_td\"> <span>Sample</span> </td>";
    for (recNum = _i = 0, _ref = report[0].records.length; 0 <= _ref ? _i < _ref : _i > _ref; recNum = 0 <= _ref ? ++_i : --_i) {
      pos = columnOrder[recNum];
      rec = report[0].records[pos];
      metric = rec.metric;
      if (metric.description) {
        metric_html = "<a class=\"tooltip-link\" rel=\"tooltip\" title=\"" + metric.description + "\"> " + metric.short_name + " </a>";
      } else {
        if (metric.short_name === void 0) {
          metric_html = metric.name;
        } else {
          metric_html = metric.short_name;
        }
      }
      table += "<td class='second_through_last_col_headers_td' position='" + pos + "'> <span class='drag_handle'><span class='drag_image'></span></span> <span class='metric_name'>" + metric_html + "</span> </td>";
    }
    for (_j = 0, _len = report.length; _j < _len; _j++) {
      sampleReport = report[_j];
      sampleName = sampleReport.sample.name;
      sampleLink = sampleReport.link;
      if (sampleName.length > 30) {
        sampleName = "<span title=\"" + sampleName + "\">" + (sampleName.trunc(80)) + "</span>";
      }
      table += "\n<tr> <td class=\"left_column_td\"> <a class=\"sample_name\" href=\"" + sampleLink + "\">" + sampleName + "</a> </td>";
      for (recNum = _k = 0, _ref1 = sampleReport.records.length; 0 <= _ref1 ? _k < _ref1 : _k > _ref1; recNum = 0 <= _ref1 ? ++_k : --_k) {
        pos = columnOrder[recNum];
        rec = sampleReport.records[pos];
        metric = rec.metric;
        value = rec.value;
        if ((value == null) || value === '') {
          rec.cell_contents = '-';
        } else {
          if (typeof value === 'number') {
            rec.num = value;
            rec.cell_contents = toPrettyString(value, metric.unit);
          } else if (/^-?.?[0-9]/.test(value)) {
            result = /([0-9\.]+)(.*)/.exec(value);
            rec.num = parseFloat(result[1]);
            rec.cell_contents = toPrettyString(rec.num, metric.unit) + result[2];
          } else {
            rec.cell_contents = value;
          }
        }
        table += "<td metric=\"" + metric.name + "\" quality=\"" + metric.quality + "\"";
        if (rec.num != null) {
          table += ' number="' + rec.value + '">';
        }
        table += "<a " + (get_meta_tag_contents(rec)) + ">" + rec.cell_contents + "</a></td>";
      }
      table += "</tr>";
    }
    table += "\n</table>\n";
    $('#report').append(table);
    $('#report_legend').append(legend);
    add_heatmap();
    legend = '<span>';
    step = 6;
    for (hue = _l = RED_HUE; step > 0 ? _l <= GREEN_HUE : _l >= GREEN_HUE; hue = _l += step) {
      lightness = (Math.pow(hue - 75, 2)) / 350 + 35;
      legend += "<span style=\"color: hsl(" + hue + ", 80%, " + lightness + "%);\">";
      switch (hue) {
        case RED_HUE:
          legend += 'w';
          break;
        case RED_HUE + step:
          legend += 'o';
          break;
        case RED_HUE + 2 * step:
          legend += 'r';
          break;
        case RED_HUE + 3 * step:
          legend += 's';
          break;
        case RED_HUE + 4 * step:
          legend += 't';
          break;
        case GREEN_HUE - 3 * step:
          legend += 'b';
          break;
        case GREEN_HUE - 2 * step:
          legend += 'e';
          break;
        case GREEN_HUE - step:
          legend += 's';
          break;
        case GREEN_HUE:
          legend += 't';
          break;
        default:
          legend += '.';
      }
      legend += "</span>";
    }
    return legend += "</span>";
  };

  css_property_to_color = 'background-color';

  get_color = function(hue) {
    var lightness;
    lightness = 85;
    return 'hsl(' + hue + ', 80%, ' + lightness + '%)';
  };

  add_heatmap = function() {
    var processes_metrics;
    processes_metrics = [];
    return $(".report_table td[number]").each(function() {
      var cell, k, left_part, left_part_width, max, maxHue, min, minHue, offset, orther_numbers, other_cells, parts, quality, width, _i, _j, _len, _len1, _ref;
      metric = $(this).attr('metric');
      if (!(__indexOf.call(processes_metrics, metric) >= 0)) {
        quality = $(this).attr('quality');
        other_cells = $('.report_table').find("td[metric=\"" + metric + "\"][number]");
        orther_numbers = (function() {
          var _i, _len, _results;
          _results = [];
          for (_i = 0, _len = other_cells.length; _i < _len; _i++) {
            cell = other_cells[_i];
            _results.push($(cell).attr('number'));
          }
          return _results;
        })();
        min = Math.min.apply(null, orther_numbers);
        max = Math.max.apply(null, orther_numbers);
        maxHue = GREEN_HUE;
        minHue = RED_HUE;
        if (quality === 'Less is better') {
          maxHue = RED_HUE;
          minHue = GREEN_HUE;
        }
        if (max === min) {
          $(other_cells).css(css_property_to_color, get_color(GREEN_HUE));
        } else {
          k = (maxHue - minHue) / (max - min);
          other_cells.each(function(i) {
            var hue, number;
            number = orther_numbers[i];
            hue = Math.round(minHue + (number - min) * k);
            $(this).css(css_property_to_color, get_color(hue));
            if (orther_numbers.length > 1) {
              return $('#report_legend').show('fast');
            }
          });
        }
        left_part_width = 0;
        _ref = $(other_cells);
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          cell = _ref[_i];
          parts = $(cell).text().split('.');
          if (parts.length > 1) {
            left_part = '.' + parts[-1];
          } else {
            left_part = '';
          }
          width = $.fn.textWidth(left_part);
          if (width > left_part_width) {
            left_part_width = width;
          }
        }
        if (left_part_width > 0) {
          Console.log(left_part_width);
        }
        for (_j = 0, _len1 = other_cells.length; _j < _len1; _j++) {
          cell = other_cells[_j];
          offset = $(cell).offset();
          offset.left += left_part_width;
          $(cell).offset(offset);
        }
        return processes_metrics.push(metric);
      }
    });
  };

  $.fn.textWidth = function(text) {
    if (!$.fn.textWidth.fakeEl) {
      $.fn.textWidth.fakeEl = $('<span>').hide().appendTo(document.body);
    }
    $.fn.textWidth.fakeEl.text(text);
    $.fn.textWidth.fakeEl.css('font', this.css('font'));
    return $.fn.textWidth.fakeEl.width();
  };

}).call(this);

//# sourceMappingURL=build_total_report.map
